<!doctype html>
<html lang="es" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <meta name="color-scheme" content="light dark" />
    
    <!-- Content Security Policy optimizada para GitHub Pages -->
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'self';
      script-src 'self' 'sha256-47DEQpj8HBSa+/TImW+5JCeuQeRkm5NMpJWZG3hSuFU=' 'sha256-+6WnXIl4mbFTCARd8NnhCOGPMRz7T32y8vSJjXj+geU=' https://cdn.jsdelivr.net https://unpkg.com https://maps.googleapis.com *.github.io *.githubpages.com;
      style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
      img-src 'self' data: https: blob:;
      font-src 'self' data: https://fonts.gstatic.com;
      connect-src 'self' https://maps.googleapis.com https://*.googleapis.com ws: wss:;
      frame-src 'none'; object-src 'none'; media-src 'self';
      worker-src 'self' blob:; manifest-src 'self';
      base-uri 'self'; form-action 'self';
    ">
    
    <title>Beyond Calculator - Experiencia Inmobiliaria Gamificada</title>
    <link
      rel="icon"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Ctext y='20' font-size='20'%3EüèóÔ∏è%3C/text%3E%3C/svg%3E"
      type="image/svg+xml"
    />

    <!-- Reutilizar estilos base -->
    <link rel="stylesheet" href="./css/tailwind-static.css" />
    <link rel="stylesheet" href="./css/colors.css" />
    <link rel="stylesheet" href="./css/language-selector.css" />

    <!-- Tailwind CSS -->

    <!-- Babylon.js para 3D - Using cdn.jsdelivr.net -->
    <script src="https://cdn.jsdelivr.net/npm/babylonjs@6.0.0/babylon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/babylonjs-loaders@6.0.0/babylonjs.loaders.min.js"></script>

    <!-- Chart.js para KPIs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- jsPDF para exportaci√≥n - Using cdn.jsdelivr.net -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

    <!-- i18n y m√≥dulos -->
    <script type="module" src="./js/main.js"></script>
    <script src="./js/modules/wizard.js"></script>
    <script src="./js/modules/terrain.js"></script>
    <script src="./js/modules/viewer3d.js"></script>
    <script src="./js/modules/finance.js"></script>

    <!-- Alpine.js CSP Build -->
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/csp@3.x.x/dist/cdn.min.js"></script>

    <style>
      /* Estilos para gamificaci√≥n */
      .phase-indicator {
        transition: all 0.3s ease;
      }

      .phase-indicator.active {
        transform: scale(1.1);
        box-shadow: 0 0 20px rgba(51, 75, 78, 0.4);
      }

      .xp-bar {
        background: linear-gradient(90deg, #334b4e 0%, #54676d 100%);
        transition: width 0.5s ease;
      }

      .badge-earned {
        animation: badgeEarned 0.5s ease;
      }

      @keyframes badgeEarned {
        0% {
          transform: scale(0) rotate(0deg);
          opacity: 0;
        }
        50% {
          transform: scale(1.2) rotate(180deg);
          opacity: 1;
        }
        100% {
          transform: scale(1) rotate(360deg);
          opacity: 1;
        }
      }

      .terrain-3d-container {
        height: 500px;
        border-radius: 0.5rem;
        overflow: hidden;
      }

      .kpi-card {
        background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
        transition: transform 0.2s ease;
      }

      .dark .kpi-card {
        background: linear-gradient(135deg, #243b44 0%, #334b4e 100%);
      }

      .kpi-card:hover {
        transform: translateY(-2px);
      }

      /* Loader animation */
      .loader {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #334b4e;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Hide elements with x-cloak until Alpine.js is ready */
      [x-cloak] {
        display: none !important;
      }

      /* Accessible form-field styles ‚Äì WCAG AA compliant */
      :root {
        --input-bg: #fff;
        --input-text: #0f172a;
        --input-border: #94a3b8;
        --input-placeholder: #6b7280;
        --focus-ring: #2563eb;
      }
      .dark {
        --input-bg: #1f2937;
        --input-text: #f1f5f9;
        --input-border: #475569;
        --input-placeholder: #9ca3af;
        --focus-ring: #3b82f6;
      }
      input:not([type='radio']):not([type='checkbox']),
      textarea,
      select {
        background-color: var(--input-bg);
        color: var(--input-text);
        border: 1px solid var(--input-border);
        border-radius: 0.5rem;
        width: 100%;
        padding: 0.5rem 1rem;
        line-height: 1.5;
        transition:
          border-color 0.15s ease,
          background-color 0.15s ease;
      }
      input:not([type='radio']):not([type='checkbox']):hover,
      textarea:hover,
      select:hover {
        border-color: var(--focus-ring);
      }
      input:not([type='radio']):not([type='checkbox']):focus-visible,
      textarea:focus-visible,
      select:focus-visible {
        outline: 2px solid var(--focus-ring);
        outline-offset: 2px;
      }
      input::placeholder,
      textarea::placeholder {
        color: var(--input-placeholder);
        opacity: 1;
      }
      input:disabled,
      textarea:disabled,
      select:disabled {
        background-color: #f1f5f9;
        color: #9ca3af;
        cursor: not-allowed;
      }
      .dark input:disabled,
      .dark textarea:disabled,
      .dark select:disabled {
        background-color: #334155;
        color: #64748b;
      }
    </style>
  </head>
  <body
    class="font-body antialiased leading-relaxed text-zinc-800 dark:text-zinc-200 bg-white dark:bg-zinc-900"
  >
    <!-- Header reutilizado de index.html -->
    <header
      x-data="nav"
      x-init="init"
      class="fixed inset-x-0 top-0 z-50 bg-white/80 dark:bg-primary-900/80 backdrop-blur shadow-sm"
    >
      <div class="mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between h-16">
        <a href="index.html#about" class="text-primary-800 dark:text-white font-bold text-lg"
          >Beyond&nbsp;Solutions</a
        >

        <nav class="hidden md:flex space-x-6">
          <a href="index.html" class="hover:text-primary-800 dark:hover:text-accent-50">Inicio</a>
          <a
            href="calculator-gamified.html"
            class="text-primary-800 dark:text-accent-50 font-semibold"
            >Calculadora</a
          >
          <a href="dashboard.html" class="hover:text-primary-800 dark:hover:text-accent-50"
            >Mis Proyectos</a
          >
          <a href="index.html#contacto" class="hover:text-primary-800 dark:hover:text-accent-50"
            >Contacto</a
          >
        </nav>

        <div class="flex items-center space-x-4">
          <div class="language-selector"></div>
          <button @click="toggleTheme" class="p-2 bg-accent-50 dark:bg-primary-800 rounded-full">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
            </svg>
          </button>
        </div>
      </div>
    </header>

    <main class="py-16 min-h-screen" x-data="calculatorGamified" x-init="init">
      <!-- Gamification Header -->
      <div class="bg-gradient-to-r from-primary-800 to-primary-700 text-white py-4 px-6 mb-8">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <div class="text-2xl font-bold">Nivel <span x-text="playerLevel"></span></div>
            <div class="w-48 bg-primary-900/50 rounded-full h-3">
              <div class="xp-bar h-full rounded-full" x-bind:style="xpBarStyle"></div>
            </div>
            <div class="text-sm">
              <span x-text="currentXP"></span> / <span x-text="nextLevelXP"></span> XP
            </div>
          </div>

          <div class="flex items-center space-x-4">
            <div class="flex space-x-2">
              <template x-for="badge in recentBadges" :key="badge.id">
                <div
                  class="w-10 h-10 rounded-full bg-accent-200 flex items-center justify-center"
                  :title="badge.name"
                >
                  <span x-text="badge.icon"></span>
                </div>
              </template>
            </div>
            <button
              @click="openLeaderboard()"
              class="px-4 py-2 bg-accent-200 text-primary-900 rounded-full text-sm font-semibold"
            >
              üèÜ Ranking
            </button>
          </div>
        </div>
      </div>

      <!-- Progress Phases -->
      <div class="max-w-7xl mx-auto px-6 mb-8">
        <div class="flex justify-center flex-wrap items-center gap-4 sm:gap-6 md:gap-10">
          <template x-for="(phase, index) in phases" :key="phase.id">
            <div class="relative flex flex-col items-center w-20 sm:w-24 md:w-28">
              <div class="flex items-center">
                <div
                  class="phase-indicator w-16 h-16 rounded-full flex items-center justify-center text-white font-bold text-xl cursor-pointer transition-all"
                  x-bind:class="phaseIndicatorClass[index]"
                  @click="handlePhaseClick(index)"
                >
                  <span x-text="phase.icon"></span>
                </div>
                <div
                  x-show="phaseConnectorVisible[index]"
                  class="h-1 flex-grow mx-2"
                  x-bind:class="phaseConnectorClass[index]"
                ></div>
              </div>
              <div class="mt-2 text-center whitespace-nowrap">
                <p class="text-sm font-semibold" x-text="phase.name"></p>
                <p class="text-xs text-gray-500" x-text="phaseXpText[index]"></p>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="max-w-7xl mx-auto px-6">
        <div class="bg-white dark:bg-zinc-800 rounded-lg shadow-lg p-8">
          <!-- Phase 1: Wizard/Onboarding -->
          <div x-show="phaseVisible[0]" x-transition>
            <h2 class="text-3xl font-bold mb-6">üéØ Comencemos tu proyecto</h2>

            <div class="space-y-8">
              <!-- Pregunta 1: Perfil -->
              <div x-show="wizardStepVisible[0]">
                <h3 class="text-xl font-semibold mb-4">¬øCu√°l es tu perfil?</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <button
                    @click="selectProfile('developer')"
                    class="p-6 border-2 rounded-lg text-center hover:border-primary-700 transition"
                    :class="profileClass.developer"
                  >
                    <div class="text-3xl mb-2">üèóÔ∏è</div>
                    <div class="font-semibold">Desarrollador</div>
                  </button>

                  <button
                    @click="selectProfile('owner')"
                    class="p-6 border-2 rounded-lg text-center hover:border-primary-700 transition"
                    :class="profileClass.owner"
                  >
                    <div class="text-3xl mb-2">üè†</div>
                    <div class="font-semibold">Propietario</div>
                  </button>

                  <button
                    @click="selectProfile('investor')"
                    class="p-6 border-2 rounded-lg text-center hover:border-primary-700 transition"
                    :class="profileClass.investor"
                  >
                    <div class="text-3xl mb-2">üí∞</div>
                    <div class="font-semibold">Inversionista</div>
                  </button>

                  <button
                    @click="selectProfile('architect')"
                    class="p-6 border-2 rounded-lg text-center hover:border-primary-700 transition"
                    :class="profileClass.architect"
                  >
                    <div class="text-3xl mb-2">üìê</div>
                    <div class="font-semibold">Arquitecto</div>
                  </button>
                </div>
              </div>

              <!-- Pregunta 2: Tipo de Proyecto -->
              <div x-show="wizardStepVisible[1]">
                <h3 class="text-xl font-semibold mb-4">¬øQu√© tipo de proyecto tienes en mente?</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <button
                    @click="selectProjectType('residential')"
                    class="p-6 border-2 rounded-lg text-center hover:border-primary-700 transition"
                    :class="projectTypeClass.residential"
                  >
                    <div class="text-3xl mb-2">üèòÔ∏è</div>
                    <div class="font-semibold">Residencial</div>
                  </button>

                  <button
                    @click="selectProjectType('commercial')"
                    class="p-6 border-2 rounded-lg text-center hover:border-primary-700 transition"
                    :class="projectTypeClass.commercial"
                  >
                    <div class="text-3xl mb-2">üè¢</div>
                    <div class="font-semibold">Comercial</div>
                  </button>

                  <button
                    @click="selectProjectType('mixed')"
                    class="p-6 border-2 rounded-lg text-center hover:border-primary-700 transition"
                    :class="projectTypeClass.mixed"
                  >
                    <div class="text-3xl mb-2">üèôÔ∏è</div>
                    <div class="font-semibold">Mixto</div>
                  </button>

                  <button
                    @click="selectProjectType('industrial')"
                    class="p-6 border-2 rounded-lg text-center hover:border-primary-700 transition"
                    :class="projectTypeClass.industrial"
                  >
                    <div class="text-3xl mb-2">üè≠</div>
                    <div class="font-semibold">Industrial</div>
                  </button>
                </div>
              </div>

              <!-- Project Details -->
              <div x-show="wizardStepVisible[2]">
                <h3 class="text-xl font-semibold mb-4">Dale un nombre a tu proyecto</h3>
                <div class="space-y-4">
                  <div>
                    <label for="project-name" class="block text-sm font-medium mb-2"
                      >Nombre del proyecto</label
                    >
                    <input
                      type="text"
                      id="project-name"
                      name="projectName"
                      x-model="formData.projectName"
                      class="w-full px-4 py-2 border rounded-lg dark:bg-zinc-700 dark:border-zinc-600 focus:ring-2 focus:ring-primary-800 focus:border-transparent"
                      placeholder="Mi proyecto inmobiliario"
                      data-validate="projectName"
                      aria-required="true"
                      aria-describedby="project-name-help"
                    />
                    <p id="project-name-help" class="sr-only">
                      Ingresa un nombre descriptivo para tu proyecto inmobiliario
                    </p>
                  </div>
                  <div>
                    <label for="location-autocomplete" class="block text-sm font-medium mb-2"
                      >Ubicaci√≥n</label
                    >
                    <input
                      type="text"
                      x-model="formData.location"
                      id="location-autocomplete"
                      name="location"
                      class="w-full px-4 py-2 border rounded-lg dark:bg-zinc-700 dark:border-zinc-600 focus:ring-2 focus:ring-primary-800 focus:border-transparent"
                      placeholder="Buscar direcci√≥n..."
                      @focus="initLocationAutocomplete()"
                      @input="formData.location = $event.target.value"
                      data-validate="location"
                      aria-required="true"
                      aria-describedby="location-help"
                      aria-autocomplete="list"
                    />
                    <p id="location-help" class="text-xs text-gray-500 mt-1">
                      Comienza a escribir para buscar direcciones
                    </p>
                  </div>
                </div>
              </div>

              <!-- Navigation -->
              <div class="flex justify-between mt-8">
                <button
                  x-show="wizardNavButtonVisible"
                  @click="wizardStep--"
                  class="px-6 py-3 bg-gray-200 dark:bg-gray-700 rounded-full"
                >
                  Anterior
                </button>

                <button
                  x-show="wizardNextButtonVisible"
                  @click="nextWizardStep()"
                  :disabled="!canProceedWizardFlag"
                  class="px-6 py-3 bg-primary-800 text-white rounded-full disabled:opacity-50"
                >
                  Siguiente
                </button>

                <button
                  x-show="wizardFinishButtonVisible"
                  @click="completePhase1()"
                  :disabled="!canCompleteWizardFlag"
                  class="px-6 py-3 bg-primary-800 text-white rounded-full disabled:opacity-50"
                >
                  Continuar al Terreno
                </button>
              </div>
            </div>
          </div>

          <!-- Phase 2: Terreno -->
          <div x-show="phaseVisible[1]" x-transition>
            <h2 class="text-3xl font-bold mb-6">üó∫Ô∏è Configura tu terreno</h2>

            <div class="space-y-8">
              <!-- Origen del terreno -->
              <div x-show="terrainStepVisible[0]">
                <h3 class="text-xl font-semibold mb-4">¬øDe d√≥nde obtendr√°s el terreno?</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <button
                    @click="selectTerrainSource('own')"
                    class="p-6 border-2 rounded-lg text-center hover:border-primary-700 transition"
                    :class="terrainSourceClass.own"
                  >
                    <div class="text-3xl mb-2">üìç</div>
                    <div class="font-semibold">Terreno Propio</div>
                    <p class="text-sm text-gray-500 mt-2">Dibuja o importa tu terreno</p>
                  </button>

                  <button
                    @click="selectTerrainSource('catalog')"
                    class="p-6 border-2 rounded-lg text-center hover:border-primary-700 transition"
                    :class="terrainSourceClass.catalog"
                  >
                    <div class="text-3xl mb-2">üè™</div>
                    <div class="font-semibold">Cat√°logo</div>
                    <p class="text-sm text-gray-500 mt-2">Explora terrenos disponibles</p>
                  </button>

                  <button
                    @click="selectTerrainSource('search')"
                    class="p-6 border-2 rounded-lg text-center hover:border-primary-700 transition"
                    :class="terrainSourceClass.search"
                  >
                    <div class="text-3xl mb-2">üîç</div>
                    <div class="font-semibold">Buscar en Mapa</div>
                    <p class="text-sm text-gray-500 mt-2">Encuentra terrenos en el mapa</p>
                  </button>
                </div>
              </div>

              <!-- Mapa Interactivo -->
              <div x-show="terrainStepVisible[1]" class="space-y-4">
                <h3 class="text-xl font-semibold mb-4">Dibuja o selecciona tu terreno</h3>

                <!-- Placeholder para Google Maps -->
                <div
                  id="terrain-map"
                  class="w-full h-96 bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-center"
                >
                  <div class="text-center">
                    <div class="loader mx-auto mb-4"></div>
                    <p class="text-gray-500">Cargando mapa...</p>
                    <p class="text-sm text-gray-400 mt-2">API Key requerida</p>
                  </div>
                </div>

                <!-- Controles del mapa -->
                <div class="flex space-x-4">
                  <button class="px-4 py-2 bg-primary-800 text-white rounded-lg">
                    ‚úèÔ∏è Dibujar Pol√≠gono
                  </button>
                  <button
                    @click="importTerrain()"
                    :disabled="!terrainReady"
                    :class="terrainBtnClass.normal"
                  >
                    üìÅ Importar CAD/GeoJSON
                  </button>
                  <button
                    @click="toggleMeasure()"
                    :disabled="!terrainReady"
                    :class="terrainBtnClass.normal"
                  >
                    üìè Medir
                  </button>
                  <button
                    @click="resetTerrain()"
                    :disabled="!terrainReady"
                    :class="terrainBtnClass.danger"
                  >
                    üóëÔ∏è Limpiar
                  </button>
                </div>

                <!-- Info del terreno -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                  <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">√Årea</p>
                    <p class="text-xl font-bold" id="terrain-area">0 m¬≤</p>
                  </div>
                  <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">Per√≠metro</p>
                    <p class="text-xl font-bold" id="terrain-perimeter">0 m</p>
                  </div>
                  <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">Elevaci√≥n</p>
                    <p class="text-xl font-bold" data-terrain="elevation">-- msnm</p>
                  </div>
                  <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">Uso de Suelo</p>
                    <p class="text-xl font-bold" data-terrain="landuse">Por determinar</p>
                  </div>
                  <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">Pendiente</p>
                    <p class="text-xl font-bold" data-terrain="slope">-- %</p>
                  </div>
                  <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">Restricciones</p>
                    <p class="text-xl font-bold" data-terrain="restrictions">Ninguna</p>
                  </div>
                  <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">Zona</p>
                    <p class="text-xl font-bold" data-terrain="zone">Por verificar</p>
                  </div>
                  <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">Coordenadas</p>
                    <p class="text-xl font-bold" data-terrain="coords">-- puntos</p>
                  </div>
                </div>
              </div>

              <!-- Vista 3D del Terreno -->
              <div x-show="terrainStepVisible[2]" class="space-y-4">
                <h3 class="text-xl font-semibold mb-4">Vista 3D de tu terreno</h3>

                <div class="terrain-3d-container bg-gray-100 dark:bg-gray-900">
                  <canvas id="viewer3d-canvas" class="w-full h-full"></canvas>
                </div>

                <!-- Controles 3D -->
                <div class="flex space-x-4">
                  <button
                    @click="toggleDayNight()"
                    class="px-4 py-2 bg-primary-800 text-white rounded-lg hover:bg-primary-700 transition"
                  >
                    <span x-text="dayNightLabel"></span>
                  </button>
                  <button
                    @click="toggleSolarAnalysis()"
                    :class="solarBtnClass"
                  >
                    üå§Ô∏è An√°lisis Solar
                  </button>
                  <button
                    @click="toggleWindAnalysis()"
                    :class="windBtnClass"
                  >
                    üí® An√°lisis de Viento
                  </button>
                </div>
              </div>

              <!-- Navigation -->
              <div class="flex justify-between mt-8">
                <button
                  @click="terrainStep > 0 ? terrainStep-- : currentPhase--"
                  class="px-6 py-3 bg-gray-200 dark:bg-gray-700 rounded-full"
                >
                  Anterior
                </button>

                <button
                  @click="nextTerrainStep()"
                  class="px-6 py-3 bg-primary-800 text-white rounded-full"
                >
                  <span x-text="terrainStepText"></span>
                </button>
              </div>
            </div>
          </div>

          <!-- Phase 3: Costos -->
          <div x-show="phaseVisible[2]" x-transition>
            <h2 class="text-3xl font-bold mb-6">üí∞ An√°lisis de Costos</h2>

            <div class="space-y-8">
              <!-- Sistema Constructivo -->
              <div>
                <h3 class="text-xl font-semibold mb-4">Sistema Constructivo</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <label class="cursor-pointer">
                    <input
                      type="radio"
                      name="construction"
                      value="traditional"
                      x-model="formData.constructionSystem"
                      @change="updateConstructionSystem()"
                      class="sr-only"
                    />
                    <div
                      class="p-4 border-2 rounded-lg text-center transition"
                      :class="constructionSystemClass.traditional"
                    >
                      <div class="text-2xl mb-2">üß±</div>
                      <div class="font-semibold">Tradicional</div>
                    </div>
                  </label>

                  <label class="cursor-pointer">
                    <input
                      type="radio"
                      name="construction"
                      value="prefab"
                      x-model="formData.constructionSystem"
                      @change="updateConstructionSystem()"
                      class="sr-only"
                    />
                    <div
                      class="p-4 border-2 rounded-lg text-center transition"
                      :class="constructionSystemClass.prefab"
                    >
                      <div class="text-2xl mb-2">üèóÔ∏è</div>
                      <div class="font-semibold">Prefabricado</div>
                    </div>
                  </label>

                  <label class="cursor-pointer">
                    <input
                      type="radio"
                      name="construction"
                      value="steel"
                      x-model="formData.constructionSystem"
                      @change="updateConstructionSystem()"
                      class="sr-only"
                    />
                    <div
                      class="p-4 border-2 rounded-lg text-center transition"
                      :class="constructionSystemClass.steel"
                    >
                      <div class="text-2xl mb-2">üè¢</div>
                      <div class="font-semibold">Acero</div>
                    </div>
                  </label>

                  <label class="cursor-pointer">
                    <input
                      type="radio"
                      name="construction"
                      value="eco"
                      x-model="formData.constructionSystem"
                      @change="updateConstructionSystem()"
                      class="sr-only"
                    />
                    <div
                      class="p-4 border-2 rounded-lg text-center transition"
                      :class="constructionSystemClass.eco"
                    >
                      <div class="text-2xl mb-2">üåø</div>
                      <div class="font-semibold">Ecol√≥gico</div>
                    </div>
                  </label>
                </div>
              </div>

              <!-- Nivel de Materiales -->
              <div>
                <h3 class="text-xl font-semibold mb-4">Nivel de Materiales</h3>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                  <label class="cursor-pointer">
                    <input
                      type="radio"
                      name="materials"
                      value="basic"
                      x-model="formData.materialLevel"
                      @change="updateMaterialLevel()"
                      class="sr-only"
                    />
                    <div
                      class="p-4 border-2 rounded-lg text-center transition"
                      :class="materialLevelClass.basic"
                    >
                      <div class="text-xl mb-1">üíµ</div>
                      <div class="font-semibold">B√°sico</div>
                      <div class="text-sm text-gray-500">$8,000/m¬≤</div>
                    </div>
                  </label>

                  <label class="cursor-pointer">
                    <input
                      type="radio"
                      name="materials"
                      value="standard"
                      x-model="formData.materialLevel"
                      @change="updateMaterialLevel()"
                      class="sr-only"
                    />
                    <div
                      class="p-4 border-2 rounded-lg text-center transition"
                      :class="materialLevelClass.standard"
                    >
                      <div class="text-xl mb-1">üíµüíµ</div>
                      <div class="font-semibold">Est√°ndar</div>
                      <div class="text-sm text-gray-500">$12,000/m¬≤</div>
                    </div>
                  </label>

                  <label class="cursor-pointer">
                    <input
                      type="radio"
                      name="materials"
                      value="premium"
                      x-model="formData.materialLevel"
                      @change="updateMaterialLevel()"
                      class="sr-only"
                    />
                    <div
                      class="p-4 border-2 rounded-lg text-center transition"
                      :class="materialLevelClass.premium"
                    >
                      <div class="text-xl mb-1">üíµüíµüíµ</div>
                      <div class="font-semibold">Premium</div>
                      <div class="text-sm text-gray-500">$18,000/m¬≤</div>
                    </div>
                  </label>

                  <label class="cursor-pointer">
                    <input
                      type="radio"
                      name="materials"
                      value="luxury"
                      x-model="formData.materialLevel"
                      @change="updateMaterialLevel()"
                      class="sr-only"
                    />
                    <div
                      class="p-4 border-2 rounded-lg text-center transition"
                      :class="materialLevelClass.luxury"
                    >
                      <div class="text-xl mb-1">üíé</div>
                      <div class="font-semibold">Lujo</div>
                      <div class="text-sm text-gray-500">$25,000/m¬≤</div>
                    </div>
                  </label>

                  <label class="cursor-pointer">
                    <input
                      type="radio"
                      name="materials"
                      value="custom"
                      x-model="formData.materialLevel"
                      @change="updateMaterialLevel()"
                      class="sr-only"
                    />
                    <div
                      class="p-4 border-2 rounded-lg text-center transition"
                      :class="materialLevelClass.custom"
                    >
                      <div class="text-xl mb-1">‚öôÔ∏è</div>
                      <div class="font-semibold">Personalizado</div>
                      <div class="text-sm text-gray-500">Definir</div>
                    </div>
                  </label>
                </div>
              </div>

              <!-- KPIs Financieros -->
              <div>
                <h3 class="text-xl font-semibold mb-4">Indicadores Financieros</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div class="kpi-card p-6 rounded-lg">
                    <p class="text-sm text-gray-500 dark:text-gray-400">ROI</p>
                    <p
                      class="text-3xl font-bold text-primary-800 dark:text-primary-300"
                      data-indicator="roi"
                    >
                      --
                    </p>
                    <p class="text-xs text-gray-500 trend">Calculando...</p>
                  </div>

                  <div class="kpi-card p-6 rounded-lg">
                    <p class="text-sm text-gray-500 dark:text-gray-400">TIR</p>
                    <p
                      class="text-3xl font-bold text-primary-800 dark:text-primary-300"
                      data-indicator="irr"
                    >
                      --
                    </p>
                    <p class="text-xs text-gray-500 trend">Calculando...</p>
                  </div>

                  <div class="kpi-card p-6 rounded-lg">
                    <p class="text-sm text-gray-500 dark:text-gray-400">VAN</p>
                    <p
                      class="text-3xl font-bold text-primary-800 dark:text-primary-300"
                      data-indicator="npv"
                    >
                      --
                    </p>
                    <p class="text-xs text-gray-500 trend">Calculando...</p>
                  </div>

                  <div class="kpi-card p-6 rounded-lg">
                    <p class="text-sm text-gray-500 dark:text-gray-400">Payback</p>
                    <p
                      class="text-3xl font-bold text-primary-800 dark:text-primary-300"
                      data-indicator="payback"
                    >
                      --
                    </p>
                    <p class="text-xs text-gray-500 trend">Calculando...</p>
                  </div>
                </div>
              </div>

              <!-- Simulador de Escenarios -->
              <div>
                <h3 class="text-xl font-semibold mb-4">Simulador de Escenarios</h3>
                <div class="flex space-x-4 mb-4">
                  <button
                    @click="changeScenario('optimistic')"
                    :class="scenarioClass.optimistic"
                  >
                    üòä Optimista
                  </button>
                  <button
                    @click="changeScenario('realistic')"
                    :class="scenarioClass.realistic"
                  >
                    üòê Realista
                  </button>
                  <button
                    @click="changeScenario('pessimistic')"
                    :class="scenarioClass.pessimistic"
                  >
                    üòü Pesimista
                  </button>
                </div>

                <!-- Gr√°fica de proyecci√≥n -->
                <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg">
                  <canvas id="projection-chart" class="w-full h-64"></canvas>
                </div>
              </div>

              <!-- Navigation -->
              <div class="flex justify-between mt-8">
                <button
                  @click="currentPhase--"
                  class="px-6 py-3 bg-gray-200 dark:bg-gray-700 rounded-full"
                >
                  Anterior
                </button>

                <button
                  @click="completePhase3()"
                  class="px-6 py-3 bg-primary-800 text-white rounded-full"
                >
                  Ver Experiencia 3D
                </button>
              </div>
            </div>
          </div>

          <!-- Phase 4: Experiencia 3D -->
          <div x-show="phaseVisible[3]" x-transition>
            <h2 class="text-3xl font-bold mb-6">üéÆ Experiencia Inmersiva</h2>

            <div class="space-y-8">
              <!-- Visualizador 3D Principal -->
              <div class="relative">
                <div
                  class="terrain-3d-container bg-gray-100 dark:bg-gray-900"
                  style="height: 600px"
                >
                  <canvas id="immersive-canvas" class="w-full h-full"></canvas>
                </div>

                <!-- Controles flotantes -->
                <div class="absolute top-4 right-4 space-y-2">
                  <button
                    class="px-4 py-2 bg-white/80 dark:bg-gray-800/80 backdrop-blur rounded-lg shadow"
                  >
                    üè† Vista Exterior
                  </button>
                  <button
                    class="px-4 py-2 bg-white/80 dark:bg-gray-800/80 backdrop-blur rounded-lg shadow"
                  >
                    üö™ Vista Interior
                  </button>
                  <button
                    class="px-4 py-2 bg-white/80 dark:bg-gray-800/80 backdrop-blur rounded-lg shadow"
                  >
                    üöÅ Vista A√©rea
                  </button>
                </div>

                <!-- Timeline d√≠a/noche -->
                <div class="absolute bottom-4 left-4 right-4">
                  <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur rounded-lg p-4">
                    <label class="text-sm font-semibold">Hora del d√≠a</label>
                    <input type="range" min="0" max="24" x-model="timeOfDay" class="w-full" />
                    <div class="flex justify-between text-xs text-gray-500">
                      <span>00:00</span>
                      <span>06:00</span>
                      <span>12:00</span>
                      <span>18:00</span>
                      <span>24:00</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Badges y Logros -->
              <div>
                <h3 class="text-xl font-semibold mb-4">üèÜ Logros Desbloqueados</h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                  <div class="text-center">
                    <div
                      class="w-20 h-20 mx-auto bg-yellow-400 rounded-full flex items-center justify-center text-3xl badge-earned"
                    >
                      üéØ
                    </div>
                    <p class="mt-2 text-sm font-semibold">Primer Proyecto</p>
                    <p class="text-xs text-gray-500">+100 XP</p>
                  </div>

                  <div class="text-center">
                    <div
                      class="w-20 h-20 mx-auto bg-blue-400 rounded-full flex items-center justify-center text-3xl badge-earned"
                    >
                      üó∫Ô∏è
                    </div>
                    <p class="mt-2 text-sm font-semibold">Cart√≥grafo</p>
                    <p class="text-xs text-gray-500">+150 XP</p>
                  </div>

                  <div class="text-center">
                    <div
                      class="w-20 h-20 mx-auto bg-green-400 rounded-full flex items-center justify-center text-3xl badge-earned"
                    >
                      üí∞
                    </div>
                    <p class="mt-2 text-sm font-semibold">Analista Financiero</p>
                    <p class="text-xs text-gray-500">+200 XP</p>
                  </div>

                  <div class="text-center opacity-50">
                    <div
                      class="w-20 h-20 mx-auto bg-gray-300 rounded-full flex items-center justify-center text-3xl"
                    >
                      üîí
                    </div>
                    <p class="mt-2 text-sm font-semibold">Visionario 3D</p>
                    <p class="text-xs text-gray-500">Bloqueado</p>
                  </div>

                  <div class="text-center opacity-50">
                    <div
                      class="w-20 h-20 mx-auto bg-gray-300 rounded-full flex items-center justify-center text-3xl"
                    >
                      üîí
                    </div>
                    <p class="mt-2 text-sm font-semibold">Master Builder</p>
                    <p class="text-xs text-gray-500">Bloqueado</p>
                  </div>
                </div>
              </div>

              <!-- Opciones de Exportaci√≥n -->
              <div>
                <h3 class="text-xl font-semibold mb-4">üì§ Compartir y Exportar</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <button
                    class="p-4 bg-gray-100 dark:bg-gray-800 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition"
                  >
                    <div class="text-2xl mb-2">üìÑ</div>
                    <div class="font-semibold">PDF</div>
                    <p class="text-xs text-gray-500">Reporte completo</p>
                  </button>

                  <button
                    class="p-4 bg-gray-100 dark:bg-gray-800 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition"
                  >
                    <div class="text-2xl mb-2">üìä</div>
                    <div class="font-semibold">Excel</div>
                    <p class="text-xs text-gray-500">An√°lisis financiero</p>
                  </button>

                  <button
                    class="p-4 bg-gray-100 dark:bg-gray-800 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition"
                  >
                    <div class="text-2xl mb-2">üéÆ</div>
                    <div class="font-semibold">glTF</div>
                    <p class="text-xs text-gray-500">Modelo 3D</p>
                  </button>

                  <button
                    class="p-4 bg-gray-100 dark:bg-gray-800 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition"
                  >
                    <div class="text-2xl mb-2">üîó</div>
                    <div class="font-semibold">Compartir</div>
                    <p class="text-xs text-gray-500">Link p√∫blico</p>
                  </button>
                </div>
              </div>

              <!-- Finalizar -->
              <div class="text-center">
                <button
                  @click="saveProject()"
                  class="px-8 py-4 bg-green-600 text-white rounded-full text-lg font-semibold hover:bg-green-700 transition"
                >
                  ‚úÖ Guardar Proyecto
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Leaderboard Modal -->
      <div
        x-show="showLeaderboard"
        x-cloak
        class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
        @click.self="closeLeaderboard()"
      >
        <div class="bg-white dark:bg-zinc-800 rounded-lg p-8 max-w-md w-full" @click.stop>
          <h3 class="text-2xl font-bold mb-6">üèÜ Tabla de Clasificaci√≥n</h3>

          <div class="space-y-4">
            <div
              class="flex items-center justify-between p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg"
            >
              <div class="flex items-center space-x-3">
                <span class="text-2xl">ü•á</span>
                <div>
                  <p class="font-semibold">ArquitectoMaster</p>
                  <p class="text-sm text-gray-500">Nivel 42</p>
                </div>
              </div>
              <div class="text-right">
                <p class="font-bold">12,450 XP</p>
              </div>
            </div>

            <div
              class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-900/20 rounded-lg"
            >
              <div class="flex items-center space-x-3">
                <span class="text-2xl">ü•à</span>
                <div>
                  <p class="font-semibold">DesarrolladorPro</p>
                  <p class="text-sm text-gray-500">Nivel 38</p>
                </div>
              </div>
              <div class="text-right">
                <p class="font-bold">10,200 XP</p>
              </div>
            </div>

            <div
              class="flex items-center justify-between p-4 bg-orange-50 dark:bg-orange-900/20 rounded-lg"
            >
              <div class="flex items-center space-x-3">
                <span class="text-2xl">ü•â</span>
                <div>
                  <p class="font-semibold">InversionistaElite</p>
                  <p class="text-sm text-gray-500">Nivel 35</p>
                </div>
              </div>
              <div class="text-right">
                <p class="font-bold">9,850 XP</p>
              </div>
            </div>

            <div class="border-t pt-4">
              <div
                class="flex items-center justify-between p-4 bg-primary-50 dark:bg-primary-900/20 rounded-lg"
              >
                <div class="flex items-center space-x-3">
                  <span class="text-2xl">üéØ</span>
                  <div>
                    <p class="font-semibold">T√∫</p>
                    <p class="text-sm text-gray-500">Nivel <span x-text="playerLevel"></span></p>
                  </div>
                </div>
                <div class="text-right">
                  <p class="font-bold"><span x-text="currentXP"></span> XP</p>
                  <p class="text-sm text-gray-500">#127</p>
                </div>
              </div>
            </div>
          </div>

          <button
            @click="closeLeaderboard()"
            class="mt-6 w-full px-4 py-2 bg-primary-800 text-white rounded-lg"
          >
            Cerrar
          </button>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer
      class="py-12 text-center border-t border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-900"
    >
      <p class="text-sm text-zinc-500 dark:text-zinc-400">
        ¬© 2025 Beyond Solutions. Todos los derechos reservados.
      </p>
    </footer>

    <!-- API Keys Configuration -->
    <script src="./config.js"></script>
    <script src="./js/config-check.js"></script>

    <!-- M√≥dulo de almacenamiento (debe cargarse antes de Alpine.js) -->
    <script src="./js/modules/storage.js"></script>

    <!-- Alpine.js CSP Components -->
    <script src="./js/alpine-csp-init.js"></script>
    <script src="./js/phase6-integration.js" type="module"></script>
  </body>
</html>
